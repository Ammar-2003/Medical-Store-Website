<!-- sales/detail.html -->
{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Sale Status Banner -->
    {% if sale.is_fully_returned %}
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-red-700">
            This sale has been fully returned. Total refund: Rs {{ sale.returned_amount|floatformat:2 }}
          </p>
        </div>
      </div>
    </div>
    {% elif has_returns %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-yellow-700">
            Partial returns processed. Refunded: Rs {{ sale.returned_amount|floatformat:2 }} of Rs {{ sale.final_amount|floatformat:2 }}
          </p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Sale Header -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
          <div>
            <h3 class="text-lg leading-6 font-medium text-gray-900">
              Sale #{{ sale.id }} - {{ sale.sale_date|date:"d M Y H:i" }}
            </h3>
            <p class="mt-1 text-sm text-gray-500">
              Transaction details and items purchased
            </p>
          </div>
          <div class="mt-4 sm:mt-0 flex space-x-2">
            {% if not sale.is_fully_returned %}
            <a href="{% url 'sales:create_return' sale.id %}" class="inline-flex items-center px-4 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
              <i class="fas fa-undo mr-2"></i> Process Return
            </a>
            {% endif %}
            <button onclick="window.print()" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              <i class="fas fa-print mr-2"></i> Print Receipt
            </button>
          </div>
        </div>
      </div>
      <div class="px-4 py-5 sm:p-6 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <p class="text-sm font-medium text-gray-500">Subtotal</p>
          <p class="mt-1 text-lg font-semibold text-gray-900">Rs {{ sale.subtotal|floatformat:2 }}</p>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-500">Discounts</p>
          <p class="mt-1 text-lg font-semibold text-red-600">-Rs {{ sale.discount_amount|floatformat:2 }}</p>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-500">Returns</p>
          <p class="mt-1 text-lg font-semibold text-red-600">-Rs {{ sale.returned_amount|floatformat:2 }}</p>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-500">Net Amount</p>
          <p class="mt-1 text-lg font-semibold text-green-600">Rs {{ sale.net_amount|floatformat:2 }}</p>
        </div>
      </div>
      <div class="px-4 py-4 border-t border-gray-200 bg-gray-50">
        <div class="flex justify-between">
          <p class="text-sm font-medium text-gray-500">Estimated Profit</p>
          <p class="text-sm font-semibold text-green-600">Rs {{ sale.total_profit|floatformat:2 }}</p>
        </div>
      </div>
    </div>

    <!-- Items Table -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Items Purchased</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medicine</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Returns</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for item in sale.items.all %}
            <tr class="{% if item.is_fully_returned %}bg-gray-50{% endif %}">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="text-sm font-medium text-gray-900">{{ item.medicine.name }}</div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                Rs {{ item.selling_price_per_unit|floatformat:2 }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ item.quantity }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                Rs {{ item.total_price|floatformat:2 }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">
                {% if item.returned_quantity > 0 %}
                {{ item.returned_quantity }} (Rs {{ item.returned_price|floatformat:2 }})
                {% else %}
                -
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium {% if item.is_fully_returned %}text-gray-500{% else %}text-green-600{% endif %}">
                Rs {{ item.net_price|floatformat:2 }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Returns Section (if any) -->
    {% if has_returns %}
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Return History</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for return in returns %}
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ return.returned_at|date:"d M Y H:i" }}
              </td>
              <td class="px-6 py-4 text-sm text-gray-500">
                {% for item in return.items.all %}
                <div>{{ item.sale_item.medicine.name }} ({{ item.quantity }})</div>
                {% endfor %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">
                Rs {{ return.refund_amount|floatformat:2 }}
              </td>
              <td class="px-6 py-4 text-sm text-gray-500">
                {{ return.reason|default:"-" }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div class="flex justify-between">
      <a href="{% url 'sales:list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <i class="fas fa-arrow-left mr-2"></i> Back to Sales List
      </a>
      {% if has_returns %}
      <a href="#" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <i class="fas fa-file-invoice mr-2"></i> View Return Receipt
      </a>
      {% endif %}
    </div>
  </div>
</div>

<style>
@media print {
  body * {
    visibility: hidden;
  }
  .bg-white, .bg-white * {
    visibility: visible;
  }
  .bg-white {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    margin: 0;
    padding: 15px;
  }
  .no-print {
    display: none !important;
  }
  .bg-gray-50 {
    background-color: transparent !important;
  }
}
</style>
{% endblock %}